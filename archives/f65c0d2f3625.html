<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>空数据段引发的问题及思考 | EXP Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="author" content="Levan">
  
  
    <meta name="description" content="日常记录与分享">
  
  
    <meta name="keywords" content="汇编语言,段重叠">
  
  
    <meta name="google-site-verification" content="W2AVg5n_ALo21rl9n3ZwS8AuEanZfJkirzrRGLLYvn4">
  
  
    <meta name="baidu-site-verification" content="BM2Q3xLpPJ">
  
  
    <meta name="360-site-verification" content="573211edf2de02c99d7b255b2c56513c">
  
  
    <link rel="short icon" type="image/x-icon" href="/Notes/css/images/favicon.ico">
  
  <link rel="canonical" href="https://evandoz.github.io/Notes/archives/f65c0d2f3625.html">
  
<link rel="stylesheet" href="/Notes/css/style.css">

<meta name="generator" content="Hexo 5.3.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="overflow" class="overflow">
    <div id="hiddenbar" class="hiddenbar">
      <div id="wrapper" class="wrapper">
        <header id="header" class="header is-post">
  <div class="outer">
    <div class="logo">
      <a class="title" href="/Notes/">EXP Notes</a>
    </div>
    <div class="nav">
      <ul id="nav-icon" class="nav-icon">
        <li></li><li></li><li></li>
      </ul>
      <ul class="nav-menu">
        
          <li class="nav-item">
            <a href="/Notes/archives">归档</a>
          </li>
        
          <li class="nav-item">
            <a href="/Notes/categories">分类</a>
          </li>
        
          <li class="nav-item">
            <a href="/Notes/tags">标签</a>
          </li>
        
          <li class="nav-item">
            <a href="/Notes/about">关于</a>
          </li>
        
      </ul>
    </div>

  </div>
</header>

        <div id="content" class="content">
    <section class="article-header inner">
      <img src="/Notes/css/images/banner2.jpg" alt="banner">
      

      
  
  	<h1 class="post-title">空数据段引发的问题及思考</h1>
  


      <div class="post-meta">
        <span class="post-date">
  <time datetime="2016-11-10T16:00:00.000Z">2016-11-11</time>
</span>

        
  <span class="post-category">
    <a class="category-link" href="/Notes/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/">编程开发</a> · <a class="category-link" href="/Notes/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/ASM/">ASM</a>
  </span>


      </div>
    </section>
    <section class="article-body inner">
      <div id="side" class="aside post left">

      </div>
      <div class="main">
        <article id="编程开发/ASM/20161111-空数据段引发的问题及思考" class="article">
          <div id="post-content" class="post-content">
            <p>之前使用<code>Dosbox</code>环境编写汇编程序遇到的一个问题，经过摸索已基本搞清楚原因。</p>
<a id="more"></a>
<h2 id="问题引入"><a class="headerlink" href="#问题引入"></a>问题引入</h2>
<hr>
<p>原题目很简单，就是将 00F~0FH 共 16 个数字写入内存 3000H 开始的连续 16 个存储单元，但是我当时很纳闷为什么要写在 3000H 开始的内存中，于是就直接写在 0000H 开始的内存单元中，而且为了省事把前一个代码的数据段、代码段定义部分直接搬过来，但是写完后发现数据段并没有用到，心想也没有什么影响，就没有管它，然后就出错了。</p>
<p><strong>代码如下：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">DATA 	SEGMENT

DATA 	ENDS
CODE 	SEGMENT
    ASSUME 	CS:CODE, DS:DATA
START:
    MOV AX,DATA
    MOV DS,AX
    MOV DI,0
    MOV CX,16
    MOV AL,0
CWRITE:
    MOV [DI],AL
    INC AL
    INC DI
    LOOP CWRITE
EXIT:
    MOV AH,4CH
    INT 21H
CODE 	ENDS
END 	START<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="问题发现"><a class="headerlink" href="#问题发现"></a>问题发现</h2>
<hr>
<p><strong>出错结果：</strong></p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox001.png" alt="errorview"><span class="caption">errorview</span></p>
<p>程序运行结束时 <code>CX=0002</code>，也就是说循环 <code>LOOP</code> 提前退出，这很奇怪！！！</p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox002.png" alt="errorview"><span class="caption">errorview</span></p>
<p>而且我们查看当前内存单元的内容发现，我们的数据并没有正确写入，最后两个数据是不正确的。</p>
<h2 id="问题解析"><a class="headerlink" href="#问题解析"></a>问题解析</h2>
<hr>
<p>为了搞清楚问题出在哪，接下来进行单步调试，来一步一步看程序是如何执行的，尤其看一下 <code>CX=0002</code> 时，程序究竟在干嘛！！！</p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox003.png" alt="trackview"><span class="caption">trackview</span></p>
<p>单步执行开始，此时 <code>CX=000F</code>，继续向下，中间部分都符合程序正常逻辑。</p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox004.png" alt="trackview"><span class="caption">trackview</span></p>
<p>现在来到 <code>CX=0002</code>，往下应该是继续执行循环体，<strong>但是</strong>，问题出现了！！！</p>
<ol>
<li>首先，冒出了一句程序中没有的代码 <code>OR AX, 05FE</code>，并且发现<code>05FE</code> 就是之前查看内存时，被错误写入的那两个数据；</li>
<li>接着看一下这条指令在内存中的位置 <code>076A:000D</code> ，单步调试开始的时候，<code>076A:000D</code> 中的指令是 <code>MOV [DI], AL</code>。也就是说，当执行若干次循环到 <code>CX=0002</code> 的时候，该内存单元的内容被修改；</li>
<li>最后来看这块连续内存(000D-000F)中存储的内容，此时这块内存中内容为 <code>OD05FE</code>，而单步调试开始的时候，该连续内存中的内容是 <code>8805</code>。</li>
</ol>
<p>通过上述三点分析，已经不难发现，我们的程序在执行的后期被我们的数据修改了，数据从 <code>0000</code> 单元开始写入，当写到 <code>000D</code> 单元时，刚好碰到代码区，将原本的循环体内容覆盖，导致本该循环执行的指令出现差错，程序异常退出。<br>
但是新的问题又出现了，数据段与代码段开始的地方为什么会离得这么近以至于出现如此近距离的冲突，我们做进一步探究…</p>
<h2 id="深入探究"><a class="headerlink" href="#深入探究"></a>深入探究</h2>
<hr>
<p>在程序开始时我们看一下数据段与代码段在内存中的位置</p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox005.png" alt="errorview"><span class="caption">errorview</span></p>
<p>程序开始前，数据段 <code>DS=075A</code>，代码段 <code>CS=076A</code>，两者相差 <code>100H</code>，即 256 个内存单元；然而当执行完装段操作(MOV DS, AX)后，数据段与代码段却变成一样的了(076A)，难怪会出现重叠。那么就是说我们定义的数据段和代码段是同一个位置开始的，那如果把数据段去掉结果会如何呢？</p>
<p><strong>代码如下：</strong></p>
<p>去掉 <code>DATA 	SEGMENT</code> 的定义</p>
<pre class="line-numbers language-none"><code class="language-none">CODE 	SEGMENT
    ASSUME 	CS:CODE
START:
    MOV DI,0
    MOV CX,16
    MOV AL,0
    ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>结果展示：</strong></p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox006.png" alt="rightview"><span class="caption">rightview</span></p>
<p>去掉数据段之后，结果是正确的，只是这时数据是写在 <code>075A:0000</code> 开始的位置了。难道我们定义了数据段就会出现这样的问题，那么当年 Intel 的工程师们也太弱了吧，居然会出现这么严重的 Bug，但接下来的探究证明 Intel 毕竟是 Intel，不然 8086 也不会成为一代经典之作。</p>
<h2 id="进一步发现"><a class="headerlink" href="#进一步发现"></a>进一步发现</h2>
<hr>
<p>在之前的代码中虽然定义了数据段，但是并没有在其中定义数据，也就是说我们定义了一个空数据段，那么现在我们在数据段中定义一个数据，虽然我们不用它。</p>
<p><strong>代码如下：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">DATA 	SEGMENT
    A DB 00H ;定义数字
DATA 	ENDS

CODE 	SEGMENT
    ASSUME 	CS:CODE, DS:DATA
START:
    MOV AX,DATA
    MOV DS,AX
    MOV DI,0
    MOV CX,16
    MOV AL,0
    ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>结果展示：</strong></p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox007.png" alt="rightview"><span class="caption">rightview</span></p>
<p>加上 <code>DATA 	SEGMENT</code> 的定义，并且在其中定义变量之后，结果正确，那么看一下此时代码段与数据段的位置。</p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox008.png" alt="rightview"><span class="caption">rightview</span></p>
<p>此时，数据段 <code>DS=076A</code>，代码段 <code>CS=076B</code>，并且装段前后皆如此，他们之间相差 <code>10H</code>，即 16 个内存单元。这里我们只定义了一个字节型数据，系统默认为我们空出 16 个字节的，那么若是定义两个，三个会如何呢？<br>
通过测试发现它是根据我们定义数据所占用内存单元的大小来为我们留出相应空间的，并且是以 16 个字节为一个单位，例如，当我们定义了 17 个字节型数据，它默认留出的空间是 32 个内存单元，当我们定义了 17 个字型数据，它默认留出的空间是 48 个内存单元，以此类推。</p>
<p>下面是定义了 17 个字节型数据的代码及演示结果。</p>
<p><strong>代码如下：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">DATA 	SEGMENT
    A DB 17 DUP(00H) ;定义数字
DATA 	ENDS

CODE 	SEGMENT
    ASSUME 	CS:CODE, DS:DATA
START:
    MOV AX,DATA
    MOV DS,AX
    MOV DI,0
    MOV CX,16
    MOV AL,0
    ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>结果展示：</strong></p>
<p><img src="https://raw.githubusercontent.com/Evandoz/blob/master/Assembly/DosBox009.png" alt="rightview"><span class="caption">rightview</span></p>
<h2 id="总结"><a class="headerlink" href="#总结"></a>总结</h2>
<hr>
<p>血淋林的教训告诉我们没事别定义空数据段，然后把它晾在那，不然出现的问题会让人很意外！！！</p>
<p>以上便是本次编程经历的全部发现，如有问题或者类似的发现可一起交流探讨。</p>

          </div>
          <div class="post-footer">
            <div class="post-copyright">&copy; 除特殊声明外，文章著作权归作者所有，转载请注明作者及出处</div>
          </div>
        </article>
        <!-- Pagination -->
        
          <div class="nagination card">
            
              <a href="/Notes/archives/8c8e157040aa" class="nagination-link">上篇: 使用 flow.ci 自动部署 Hexo</a>
            
            
              <a href="/Notes/archives/1134d5689b8f" class="nagination-link">下篇: 8086 通用寄存器的专用功能</a>
            
          </div>
        
        <!-- Comment -->
        <!-- 
          <div id="article-comment" class="article-comment card"></div>

         -->
      </div>
      <div id="toc" class="toc">
        
          <ol class="toc-content"><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-content-text">问题引入</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E9%97%AE%E9%A2%98%E5%8F%91%E7%8E%B0"><span class="toc-content-text">问题发现</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90"><span class="toc-content-text">问题解析</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%A9%B6"><span class="toc-content-text">深入探究</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%8F%91%E7%8E%B0"><span class="toc-content-text">进一步发现</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-content-text">总结</span></a></li></ol>
        
      </div>
    </section>


</div>
        <footer id="footer" class="footer">
  <div class="outer">
    <div class="copyright">
      <p><span>EXP Notes</span> &copy; 2015 - 2022</p>
    </div>
    <div class="navigation">
      <a href="https://evandoz.github.io">Hexo · Levan</a>
    </div>
  </div>
</footer>

      </div>
    </div>
  </div>
  
  <div id="mobile-nav" class="mobile-nav">
  
    <a class="menu-item" href="/Notes/archives">归档</a>
  
    <a class="menu-item" href="/Notes/categories">分类</a>
  
    <a class="menu-item" href="/Notes/tags">标签</a>
  
    <a class="menu-item" href="/Notes/about">关于</a>
  
</div>

<div id="over-layer" class="over-layer"></div>

  
<script src="/Notes/js/jquery.js"></script>


<script src="/Notes/js/velocity.js"></script>


<script src="/Notes/js/plugins.js"></script>


<script src="/Notes/js/script.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</body>
</html>
